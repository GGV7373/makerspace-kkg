<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Sekund√¶radmin ‚Äì Makerspace KKG</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-panel {
            position: relative;
            top: auto;
            right: auto;
            width: 100%;
            max-width: 900px;
            margin: 30px auto;
            max-height: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <a href="index.html" style="color:#000;text-decoration:none;font-weight:bold;">&larr; Tilbake til hovedsiden</a>
        </div>
        <div class="header-right">
            <h2 style="margin:0;">Sekund√¶radmin</h2>
            <button onclick="clearSession(); window.location.href='index.html';" class="admin-link-btn" style="margin-left:15px;">Logg ut</button>
        </div>
    </header>
    <main>
        <section class="admin-panel secondary-panel">
            <div class="admin-body">
                <h3>üìä Inventar-administrasjon</h3>
                <p style="color:#666;margin-bottom:20px">Oppdater lagerbeholdningen for produkter og trykkbare varer.</p>
                
                <h4 style="margin-top:25px;border-left:4px solid var(--orange);padding-left:15px">üì¶ Instruksjonsprodukter</h4>
                <p style="color:#999;font-size:13px;margin-bottom:15px">Vanlige produkter som 3D-printere, laser cutters osv.</p>
                <div id="secInventoryList"></div>
                
                <hr style="margin: 40px 0;border:none;border-top:2px solid #eee">
                
                <h4 style="margin-top:25px;border-left:4px solid var(--orange);padding-left:15px">üëï Trykkbare varer</h4>
                <p style="color:#999;font-size:13px;margin-bottom:15px">T-skjorter, hettegensere, caps og andre trykkbare varer per st√∏rrelse og farge.</p>
                <div id="secPrintableList" style="margin-bottom:20px;"></div>
                
                <hr style="margin: 40px 0;border:none;border-top:2px solid #eee">
                
                <h4 style="margin-top:25px;border-left:4px solid var(--orange);padding-left:15px">‚úâÔ∏è Tildel oppgave til superadmin</h4>
                <p style="color:#999;font-size:13px;margin-bottom:15px">Send en oppgave eller foresp√∏rsel som superadmin skal utf√∏re.</p>
                <div id="secTaskForm" class="admin-form" style="max-width:600px">
                    <select id="secTaskProduct" style="margin-bottom:10px"></select>
                    <input type="text" id="secTaskTitle" placeholder="Oppgavetittel (f.eks: Bestill mer papir til laseren)" style="margin-bottom:10px">
                    <textarea id="secTaskDesc" rows="3" placeholder="Beskrivelse eller detaljer (valgfritt)" style="margin-bottom:10px;resize:vertical"></textarea>
                    <button id="secTaskSubmit" style="margin:0">üì§ Send oppgave</button>
                </div>
            </div>
        </section>
    </main>

    <script src="auth.js"></script>
    <script>
    // ===== AUTH GUARD =====
    if(!requireAuth(['HEAD_ADMIN', 'INVENTORY_ADMIN'])) throw new Error('Not authorized');
    // ===== SHARED DATA =====
    let PRODUCTS = [];
    let PRINTABLE_ITEMS = [];

    const STORAGE_KEY = 'ms_frontend_state_v1';
    let state = {
        inventory: {},
        problems: [],
        tasks: [],
        manuals: {},
        imageFolders: [],
        images: []
    };

    // Load products from API
    async function loadProducts(){
        try {
            const response = await fetch('api/products.php');
            if (!response.ok) throw new Error('Failed to fetch products');
            PRODUCTS = await response.json();
        } catch (error) {
            console.error('Error loading products:', error);
            PRODUCTS = [];
        }
    }

    // Load printable items from API
    async function loadPrintableItems(){
        try {
            const response = await fetch('https://reg.kkgit.no/MS/api/printable-items.php');
            if (!response.ok) throw new Error('Failed to fetch printable items');
            PRINTABLE_ITEMS = await response.json();
        } catch (error) {
            console.error('Error loading printable items:', error);
            PRINTABLE_ITEMS = [];
        }
    }

    function loadState(){
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
            try{ state = Object.assign(state, JSON.parse(raw)); } catch(e){ console.warn('Could not parse state', e); }
            const secTasks = state.problems.filter(p => p.from === 'secondary');
            if(secTasks.length > 0){
                secTasks.forEach(t => {
                    if(!state.tasks.find(x => x.id === t.id)){
                        state.tasks.push(t);
                    }
                });
                state.problems = state.problems.filter(p => p.from !== 'secondary');
                saveState();
            }
        } else {
            PRODUCTS.forEach(p => state.inventory[p.id] = 1);
            state.problems.push({id:1, title:'Bed heater error (3D)', desc:'Varmer sl√•r seg av etter 2 min', status:'open', from:'user'});
        }
        state.problems.forEach(p => { if(p.status === 'resolved' && !p.resolvedAt) p.resolvedAt = new Date().toISOString(); });
        state.tasks.forEach(t => { if(t.status === 'resolved' && !t.resolvedAt) t.resolvedAt = new Date().toISOString(); });
        cleanupResolved();
    }

    function cleanupResolved(){
        const TWO_DAYS = 2 * 24 * 60 * 60 * 1000;
        const now = Date.now();
        const pLen = state.problems.length;
        state.problems = state.problems.filter(p => {
            if(p.status === 'resolved' && p.resolvedAt) return (now - new Date(p.resolvedAt).getTime()) < TWO_DAYS;
            return true;
        });
        const tLen = state.tasks.length;
        state.tasks = state.tasks.filter(t => {
            if(t.status === 'resolved' && t.resolvedAt) return (now - new Date(t.resolvedAt).getTime()) < TWO_DAYS;
            return true;
        });
        if(state.problems.length !== pLen || state.tasks.length !== tLen) saveState();
    }

    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // ===== SECONDARY ADMIN RENDERING =====
    function renderSecondaryAdmin(){
        const inv = document.getElementById('secInventoryList');
        inv.innerHTML = '';
        if(PRODUCTS.length === 0){
            inv.innerHTML = '<div style="text-align:center;padding:30px;color:#999;background:#f9f9f9;border-radius:4px">üì≠ Ingen produkter funnet</div>';
        } else {
            PRODUCTS.forEach(p => {
                const row = document.createElement('div');
                row.className = 'inventory-row';
                row.innerHTML = `
                    <img src="${p.image_url || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23f5f5f5%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2240%22 y=%2240%22 font-size=%2212%22 fill=%22%23999%22 text-anchor=%22middle%22 dominant-baseline=%22central%22%3ENg%3C/text%3E%3C/svg%3E'}" alt="${p.name}">
                    <div style="flex:1">
                        <strong style="display:block;margin-bottom:4px">${p.name}</strong>
                        <small style="color:#999">Gjeldende antall: <strong>${state.inventory[p.id] ?? 0}</strong> ${p.unit || 'stk'}</small>
                    </div>
                    <div>
                        <input type="number" min="0" data-id="${p.id}" value="${state.inventory[p.id] ?? 0}" style="width:80px">
                    </div>
                `;
                inv.appendChild(row);
            });
        }

        // Inventory change handlers
        inv.querySelectorAll('input[type=number]').forEach(inp => inp.addEventListener('change', ()=>{
            const id = Number(inp.getAttribute('data-id'));
            state.inventory[id] = Number(inp.value);
            saveState();
            inp.style.background = '#d4edda';
            setTimeout(() => inp.style.background = '', 1000);
        }));

        // Render printable items
        renderPrintableItems();

        // Populate product dropdown for task form
        const select = document.getElementById('secTaskProduct');
        select.innerHTML = PRODUCTS.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');

        // Task submit handler
        document.getElementById('secTaskSubmit').addEventListener('click', async ()=>{
            const productId = Number(document.getElementById('secTaskProduct').value);
            const title = document.getElementById('secTaskTitle').value.trim();
            const desc = document.getElementById('secTaskDesc').value.trim();
            if(!title){ alert('Skriv inn en tittel'); return; }

            try {
                const response = await fetch('api/tasks.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: desc || 'Opprettet fra sekund√¶radmin'
                    })
                });
                
                if(!response.ok) throw new Error('Failed to submit task');
                
                document.getElementById('secTaskTitle').value = '';
                document.getElementById('secTaskDesc').value = '';
                alert('‚úÖ Oppgave sendt til superadmin!');
            } catch (error) {
                console.error(error);
                alert('Kunne ikke sende oppgave');
            }
        });
    }

    // Render printable items (t-shirts, hoodies, etc.)
    async function renderPrintableItems(){
        const container = document.getElementById('secPrintableList');
        container.innerHTML = '';
        
        if (PRINTABLE_ITEMS.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;background:#f9f9f9;border-radius:4px"><p style="font-size:15px">üì≠ Ingen trykkbare varer registrert</p></div>';
            return;
        }
        
        for (const item of PRINTABLE_ITEMS) {
            try {
                const response = await fetch(`https://reg.kkgit.no/MS/api/printable-items.php?id=${item.id}`);
                const itemDetails = await response.json();
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'printable-item';
                
                let inventoryHtml = '';
                
                if (itemDetails.inventory && itemDetails.inventory.length > 0) {
                    inventoryHtml = '<table class="printable-inventory-table">';
                    inventoryHtml += '<thead><tr><th>St√∏rrelse</th><th>Farge</th><th>Antall</th><th>Min.lager</th><th>Endre</th></tr></thead><tbody>';
                    
                    itemDetails.inventory.forEach(inv => {
                        const stock = inv.quantity < inv.reorder_level ? 'printable-low-stock' : 'printable-ok-stock';
                        inventoryHtml += `<tr>
                            <td>${inv.size}</td>
                            <td>${inv.color}</td>
                            <td class="printable-qty-cell ${stock}">${inv.quantity}</td>
                            <td>${inv.reorder_level}</td>
                            <td><input type="number" class="printable-qty" data-inv-id="${inv.id}" value="${inv.quantity}" min="0"></td>
                        </tr>`;
                    });
                    inventoryHtml += '</tbody></table>';
                } else {
                    inventoryHtml = '<div style="padding:15px;background:#f9f9f9;border-radius:4px;color:#999;font-size:13px">Ingen varianter registrert</div>';
                }
                
                itemDiv.innerHTML = `
                    <div class="printable-item-header">
                        <div class="printable-item-info">
                            <h5>${item.name}</h5>
                            <small>üìÇ ${item.category || '(ingen kategori)'}</small>
                            <small>${item.description || '(ingen beskrivelse)'}</small>
                            <small style="color:#27ae60;font-weight:bold">üí∞ ${item.price ? item.price + ' kr' : 'Pris ikke satt'}</small>
                        </div>
                    </div>
                    <div style="margin-top:15px">
                        <strong style="color:#666;display:block;margin-bottom:10px">üìä Lagerbeholdning:</strong>
                        ${inventoryHtml}
                    </div>
                `;
                
                container.appendChild(itemDiv);
            } catch (error) {
                console.error('Error loading inventory for item ' + item.id, error);
            }
        }
        
        // Add change handlers for inventory inputs
        container.querySelectorAll('.printable-qty').forEach(inp => {
            inp.addEventListener('change', async (e) => {
                const invId = inp.getAttribute('data-inv-id');
                const newQty = Number(inp.value);
                
                try {
                    const response = await fetch(`https://reg.kkgit.no/MS/api/printable-inventory.php?inv_id=${invId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            quantity: newQty,
                            reason: 'Updated by secondary admin'
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to update inventory');
                    inp.style.background = '#d4edda';
                    setTimeout(() => inp.style.background = '', 1000);
                } catch (error) {
                    console.error('Error updating inventory:', error);
                    alert('Kunne ikke oppdatere inventar');
                }
            });
        });
    }

    // ===== INIT =====
    (async () => {
        await loadProducts();
        await loadPrintableItems();
        loadState();
        renderSecondaryAdmin();
    })();
    </script>
</body>
</html>
