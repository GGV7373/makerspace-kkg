<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>IT ‚Äì Makerspace KKG</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-panel {
            position: relative;
            top: auto;
            right: auto;
            width: 100%;
            max-width: 900px;
            margin: 30px auto;
            max-height: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <a href="index.html" style="color:#000;text-decoration:none;font-weight:bold;">&larr; Tilbake til hovedsiden</a>
        </div>
        <div class="header-right">
            <h2 style="margin:0;">IT</h2>
            <button onclick="clearSession(); window.location.href='index.html';" class="admin-link-btn" style="margin-left:15px;">Logg ut</button>
        </div>
    </header>
    <main>
        <section class="admin-panel head-panel">
            <div class="admin-tabs">
                <button data-tab="hProducts" class="htab-btn active">Produkter</button>
                <button data-tab="hInventory" class="htab-btn">Inventar</button>
                <button data-tab="hPrintable" class="htab-btn">Trykkvar</button>
                <button data-tab="hProblems" class="htab-btn">Problemer</button>
                <button data-tab="hTasks" class="htab-btn">Oppgaver</button>
                <button data-tab="hManuals" class="htab-btn">Manualer</button>
                <button data-tab="hImages" class="htab-btn">Bilder</button>
                <button data-tab="hAdmins" class="htab-btn">Administratorer</button>
            </div>
            <div class="admin-body">
                <div id="hProductsTab" class="admin-tab"></div>
                <div id="hInventoryTab" class="admin-tab hidden"></div>
                <div id="hPrintableTab" class="admin-tab hidden"></div>
                <div id="hProblemsTab" class="admin-tab hidden"></div>
                <div id="hTasksTab" class="admin-tab hidden"></div>
                <div id="hManualsTab" class="admin-tab hidden"></div>
                <div id="hImagesTab" class="admin-tab hidden"></div>
                <div id="hAdminsTab" class="admin-tab hidden"></div>
            </div>
        </section>
    </main>

    <!-- Manual preview modal -->
    <div id="guideModal" class="modal">
        <div class="modal-box">
            <span class="close" id="closeGuideBtn">&times;</span>
            <iframe id="guideFrame"></iframe>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
    // ===== AUTH GUARD =====
    if(!requireAuth(['HEAD_ADMIN'])) throw new Error('Not authorized');
    // ===== SHARED DATA =====
    let PRODUCTS = [];

    const STORAGE_KEY = 'ms_frontend_state_v1';
    let state = {
        inventory: {},
        problems: [],
        tasks: [],
        manuals: {},
        imageFolders: [],
        images: []
    };

    // Load products from API
    async function loadProducts(){
        try {
            const response = await fetch('api/products.php');
            if (!response.ok) throw new Error('Failed to fetch products');
            PRODUCTS = await response.json();
            console.log('Products loaded:', PRODUCTS);
        } catch (error) {
            console.error('Error loading products:', error);
            PRODUCTS = [];
        }
    }

    function loadState(){
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
            try{ state = Object.assign(state, JSON.parse(raw)); } catch(e){ console.warn('Could not parse state', e); }
            const secTasks = state.problems.filter(p => p.from === 'secondary');
            if(secTasks.length > 0){
                secTasks.forEach(t => {
                    if(!state.tasks.find(x => x.id === t.id)){
                        state.tasks.push(t);
                    }
                });
                state.problems = state.problems.filter(p => p.from !== 'secondary');
                saveState();
            }
        } else {
            PRODUCTS.forEach(p => state.inventory[p.id] = 1);
            state.problems.push({id:1, title:'Bed heater error (3D)', desc:'Varmer sl√•r seg av etter 2 min', status:'open', from:'user'});
        }
        state.problems.forEach(p => { if(p.status === 'resolved' && !p.resolvedAt) p.resolvedAt = new Date().toISOString(); });
        state.tasks.forEach(t => { if(t.status === 'resolved' && !t.resolvedAt) t.resolvedAt = new Date().toISOString(); });
        cleanupResolved();
    }

    function cleanupResolved(){
        const TWO_DAYS = 2 * 24 * 60 * 60 * 1000;
        const now = Date.now();
        const pLen = state.problems.length;
        state.problems = state.problems.filter(p => {
            if(p.status === 'resolved' && p.resolvedAt) return (now - new Date(p.resolvedAt).getTime()) < TWO_DAYS;
            return true;
        });
        const tLen = state.tasks.length;
        state.tasks = state.tasks.filter(t => {
            if(t.status === 'resolved' && t.resolvedAt) return (now - new Date(t.resolvedAt).getTime()) < TWO_DAYS;
            return true;
        });
        if(state.problems.length !== pLen || state.tasks.length !== tLen) saveState();
    }

    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // ===== TAB SWITCHING =====
    function showHeadTab(tabName){
        document.querySelectorAll('.htab-btn').forEach(b =>
            b.classList.toggle('active', b.getAttribute('data-tab') === tabName)
        );
        ['hProductsTab','hInventoryTab','hPrintableTab','hProblemsTab','hTasksTab','hManualsTab','hImagesTab','hAdminsTab'].forEach(id => {
            document.getElementById(id).classList.toggle('hidden', id !== tabName + 'Tab');
        });
        renderHeadAdmin(tabName);
    }

    // ===== RENDER DISPATCHER =====
    function renderHeadAdmin(tabName){
        if(tabName === 'hProducts') renderHeadProducts();
        else if(tabName === 'hInventory') renderHeadInventory();
        else if(tabName === 'hPrintable') renderHeadPrintable();
        else if(tabName === 'hProblems') renderHeadProblems();
        else if(tabName === 'hTasks') renderHeadTasks();
        else if(tabName === 'hManuals') renderHeadManuals();
        else if(tabName === 'hImages') renderHeadImages();
        else if(tabName === 'hAdmins') renderHeadAdmins();
    }

    // ===== PRODUCTS TAB =====
    async function renderHeadProducts(){
        const container = document.getElementById('hProductsTab');
        container.innerHTML = '<h3>üì¶ Administrer produkter</h3><p style="color:#666">Oopp, rediger og administrer alle produkter i systemet.</p>';
        
        // Add new product form
        const addForm = document.createElement('div');
        addForm.className = 'admin-form';
        addForm.innerHTML = `
            <h4>‚ûï Legg til nytt produkt</h4>
            <input type="text" id="newProdName" placeholder="Produktnavn *" required>
            <input type="text" id="newProdSku" placeholder="SKU (valgfritt)">
            <textarea id="newProdDesc" placeholder="Beskrivelse (valgfritt)" rows="2" style="resize:vertical"></textarea>
            <input type="text" id="newProdUnit" placeholder="Enhet (f.eks. stk)" value="unit">
            <button onclick="addNewProduct()">Opprett produkt</button>
        `;
        container.appendChild(addForm);
        
        // Products list
        const list = document.createElement('div');
        list.id = 'productsList';
        
        if(PRODUCTS.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:40px;color:#999"><p style="font-size:16px">üì≠ Ingen produkter funnet</p></div>';
        } else {
            PRODUCTS.forEach(p => {
                const item = document.createElement('div');
                item.className = 'product-card';
                
                const imgHtml = p.image_url ? `<img src="${p.image_url}" alt="${p.name}" class="product-image">` : '<div class="product-image" style="display:flex;align-items:center;justify-content:center;color:#999">Uten bilde</div>';
                
                item.innerHTML = `
                    ${imgHtml}
                    <div class="product-info">
                        <strong>${p.name}</strong>
                        ${p.sku ? `<small>üè∑Ô∏è SKU: ${p.sku}</small>` : ''}
                        <small>üìù ${p.description || '(ingen beskrivelse)'}</small>
                        <small>üìè Enhet: ${p.unit || 'unit'}</small>
                        <small>üñºÔ∏è Bilde: ${p.image_url ? '‚úÖ Lastet opp' : '‚ùå Mangler'}</small>
                    </div>
                    <div class="product-actions">
                        <button onclick="editProduct(${p.id})" class="btn-secondary">‚úèÔ∏è Rediger</button>
                        <button onclick="showImageUpload(${p.id})" class="btn-secondary">üñºÔ∏è Bilde</button>
                        <button onclick="deleteProduct(${p.id})" class="btn-danger">üóëÔ∏è Slett</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        container.appendChild(list);
    }

    // Product management functions
    async function addNewProduct(){
        const name = document.getElementById('newProdName').value.trim();
        const sku = document.getElementById('newProdSku').value.trim() || null;
        const desc = document.getElementById('newProdDesc').value.trim();
        const unit = document.getElementById('newProdUnit').value.trim() || 'unit';
        
        if(!name) { alert('Produktnavn kreves'); return; }
        
        try {
            const response = await fetch('api/products.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, sku, description: desc, unit })
            });
            
            if(!response.ok) throw new Error('Failed to add product');
            
            alert('Produkt lagt til!');
            document.getElementById('newProdName').value = '';
            document.getElementById('newProdSku').value = '';
            document.getElementById('newProdDesc').value = '';
            document.getElementById('newProdUnit').value = 'unit';
            
            await loadProducts();
            renderHeadProducts();
        } catch (error) {
            console.error(error);
            alert('Kunne ikke legge til produkt');
        }
    }

    async function deleteProduct(productId){
        if(!confirm('Er du sikker p√• at du vil slette dette produktet?')) return;
        
        try {
            const response = await fetch(`api/products.php?id=${productId}`, { method: 'DELETE' });
            if(!response.ok) throw new Error('Failed to delete');
            
            alert('Produkt slettet!');
            await loadProducts();
            renderHeadProducts();
        } catch (error) {
            console.error(error);
            alert('Kunne ikke slette produkt');
        }
    }

    async function editProduct(productId){
        const product = PRODUCTS.find(p => p.id === productId);
        if(!product) return;
        
        const newName = prompt('Nytt navn:', product.name);
        if(newName === null) return;
        
        const newDesc = prompt('Ny beskrivelse:', product.description || '');
        if(newDesc === null) return;
        
        try {
            const response = await fetch(`api/products.php?id=${productId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName, description: newDesc })
            });
            
            if(!response.ok) throw new Error('Failed to update');
            
            alert('Produkt oppdatert!');
            await loadProducts();
            renderHeadProducts();
        } catch (error) {
            console.error(error);
            alert('Kunne ikke oppdatere produkt');
        }
    }

    async function showImageUpload(productId){
        const product = PRODUCTS.find(p => p.id === productId);
        if(!product) return;
        
        // Create a temporary file input
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/jpeg,image/png,image/gif,image/webp';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            // Validate file size (max 5MB)
            if(file.size > 5 * 1024 * 1024) {
                alert('Filen er for stor! Maks 5MB.');
                return;
            }
            
            try {
                // Read file as data URL using FileReader
                const reader = new FileReader();
                
                reader.onload = async (event) => {
                    const base64Image = event.target.result; // This is already a data URL
                    
                    console.log('Uploading image:', {
                        productId,
                        imageDataLength: base64Image.length,
                        imageDataPrefix: base64Image.substring(0, 50)
                    });
                    
                    // Send as JSON POST request to the API server
                    const apiUrl = 'https://reg.kkgit.no/MS/api/upload.php';
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            product_id: productId,
                            image_data: base64Image
                        })
                    });
                    
                    const result = await response.json();
                    console.log('Upload response:', response.status, result);
                    
                    if(!response.ok) {
                        throw new Error(result.error || 'Upload misslyktes');
                    }
                    
                    alert('Bilde lastet opp!');
                    await loadProducts();
                    renderHeadProducts();
                };
                
                reader.onerror = () => {
                    throw new Error('Kunne ikke lese filen');
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('Kunne ikke laste opp bilde: ' + error.message);
            }
        };
        
        input.click();
    }

    // ===== INVENTORY TAB =====
    function renderHeadInventory(){
        const container = document.getElementById('hInventoryTab');
        container.innerHTML = '<h3>üìä Inventar</h3><p style="color:#666">Oppdater lagerbeholdningen for alle produkter.</p>';
        
        const list = document.createElement('div');
        PRODUCTS.forEach(p => {
            const row = document.createElement('div');
            row.className = 'inventory-row';
            row.innerHTML = `
                <img src="${p.image_url || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23f5f5f5%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2240%22 y=%2240%22 font-size=%2212%22 fill=%22%23999%22 text-anchor=%22middle%22 dominant-baseline=%22central%22%3ENg%3C/text%3E%3C/svg%3E'}" alt="${p.name}">
                <div style="flex:1">
                    <strong style="display:block;margin-bottom:4px">${p.name}</strong>
                    <small style="color:#999">Gjeldende antall: <strong>${state.inventory[p.id] ?? 0}</strong> ${p.unit || 'stk'}</small>
                </div>
                <div>
                    <input type="number" min="0" data-id="${p.id}" value="${state.inventory[p.id] ?? 0}" style="width:80px">
                </div>
            `;
            list.appendChild(row);
        });
        
        container.appendChild(list);
        
        container.querySelectorAll('input[type=number]').forEach(inp => inp.addEventListener('change', ()=>{
            const id = Number(inp.getAttribute('data-id'));
            state.inventory[id] = Number(inp.value);
            saveState();
            inp.style.background = '#d4edda';
            setTimeout(() => inp.style.background = '', 1000);
        }));
    }

    // ===== PRINTABLE ITEMS TAB =====
    async function renderHeadPrintable(){
        const container = document.getElementById('hPrintableTab');
        container.innerHTML = `
            <div style="padding:20px">
                <h3 style="margin-top:0;color:#333">üì¶ Trykkbare Varer</h3>
                <p style="color:#666;margin-bottom:20px">Administrer varer som t-skjorter, hettegensere, caps osv. med lagerbeholdning per st√∏rrelse og farge.</p>
        `;

        // Add new item form
        const addForm = document.createElement('div');
        addForm.className = 'printable-form';
        addForm.innerHTML = `
            <h4>‚ûï Legg til ny trykkbar vare</h4>
            <input type="text" id="newPrintName" placeholder="Navn (f.eks. T-skjorte, Premium)" style="margin-bottom:10px">
            <textarea id="newPrintDesc" placeholder="Beskrivelse (valgfritt)" rows="2" style="margin-bottom:10px;resize:vertical"></textarea>
            <select id="newPrintCat" style="margin-bottom:10px">
                <option value="">üìÇ Velg kategori</option>
                <option value="T-skjorter">üëï T-skjorter</option>
                <option value="Hettegensere">üß• Hettegensere</option>
                <option value="Caps">üß¢ Caps</option>
                <option value="Annet">üì¶ Annet</option>
            </select>
            <input type="number" id="newPrintPrice" placeholder="Pris (valgfritt)" step="0.01" style="margin-bottom:10px">
            <button onclick="addNewPrintable()" style="width:100%">Opprett vare</button>
        `;
        container.appendChild(addForm);

        // Load and display printable items
        try {
            console.log('Fetching printable items from https://reg.kkgit.no/MS/api/printable-items.php');
            const response = await fetch('https://reg.kkgit.no/MS/api/printable-items.php');
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const error = await response.text();
                console.error('API error response:', error);
                throw new Error(`API error ${response.status}`);
            }
            
            const items = await response.json();
            console.log('Items loaded:', items);
            
            const itemsList = document.createElement('div');
            itemsList.id = 'printablesList';
            
            if (items.length === 0) {
                itemsList.innerHTML = '<div style="text-align:center;padding:40px;color:#999"><p>üì≠ Ingen trykkbare varer registrert enn√•</p><p style="font-size:12px">Opprett en ny vare ovenfor for √• komme i gang</p></div>';
            } else {
                for (const item of items) {
                    try {
                        // Get detailed inventory
                        const detailResponse = await fetch(`https://reg.kkgit.no/MS/api/printable-items.php?id=${item.id}`);
                        const itemDetails = await detailResponse.json();
                        
                        const itemElem = document.createElement('div');
                        itemElem.className = 'printable-item';
                        
                        let inventoryTable = '<table class="printable-inventory-table">';
                        inventoryTable += '<thead><tr><th>St√∏rrelse</th><th>Farge</th><th>Antall</th><th>Min.lager</th><th>Endre</th><th>Slett</th></tr></thead><tbody>';
                        
                        if (itemDetails.inventory && itemDetails.inventory.length > 0) {
                            itemDetails.inventory.forEach(inv => {
                                const stock = inv.quantity < inv.reorder_level ? 'printable-low-stock' : 'printable-ok-stock';
                                inventoryTable += `
                                    <tr>
                                        <td>${inv.size}</td>
                                        <td>${inv.color}</td>
                                        <td class="printable-qty-cell ${stock}">${inv.quantity}</td>
                                        <td>${inv.reorder_level}</td>
                                        <td><input type="number" class="printable-qty" data-inv-id="${inv.id}" value="${inv.quantity}" min="0"></td>
                                        <td><button class="btn-delete" style="padding:4px 8px;font-size:11px" onclick="deletePrintableInv(${inv.id})">√ó</button></td>
                                    </tr>
                                `;
                            });
                        } else {
                            inventoryTable += '<tr><td colspan="6" style="text-align:center;color:#999">Ingen varianter</td></tr>';
                        }
                        inventoryTable += '</tbody></table>';
                        
                        itemElem.innerHTML = `
                            <div class="printable-item-header">
                                <div class="printable-item-info">
                                    <h5>${item.name}</h5>
                                    <small>üìÇ ${item.category || '(ingen kategori)'}</small>
                                    <small>${item.description || '(ingen beskrivelse)'}</small>
                                    <small style="color:#27ae60;font-weight:bold">üí∞ ${item.price ? item.price + ' kr' : 'Pris ikke satt'}</small>
                                    <small style="margin-top:8px;display:block;background:#f0f0f0;padding:8px;border-radius:3px">
                                        üìä Totalt lager: <strong>${item.total_quantity} stk</strong> ‚Ä¢ <strong>${item.variants}</strong> varianter
                                    </small>
                                </div>
                                <div class="printable-actions" style="flex-direction:column;width:auto">
                                    <button class="btn-edit" onclick="editPrintable(${item.id})">‚úèÔ∏è Endre</button>
                                    <button class="btn-add-variant" onclick="showAddVariant(${item.id})">+ Variant</button>
                                    <button class="btn-delete" onclick="deletePrintable(${item.id})">üóëÔ∏è Slett</button>
                                </div>
                            </div>
                            <div style="margin-top:15px">
                                <strong style="color:#666">Lagerbeholdning:</strong>
                                ${inventoryTable}
                            </div>
                        `;
                        itemsList.appendChild(itemElem);
                    } catch (itemError) {
                        console.error('Error loading item details for id ' + item.id, itemError);
                    }
                }
            }
            
            container.appendChild(itemsList);
            
            // Add event listeners for quantity changes
            container.querySelectorAll('.printable-qty').forEach(inp => {
                inp.addEventListener('change', async (e) => {
                    const invId = inp.getAttribute('data-inv-id');
                    const newQty = Number(inp.value);
                    
                    try {
                        const response = await fetch(`https://reg.kkgit.no/MS/api/printable-inventory.php?inv_id=${invId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                quantity: newQty,
                                reason: 'Updated by super admin'
                            })
                        });
                        
                        if (!response.ok) throw new Error('Failed to update');
                        inp.style.background = '#d4edda';
                        setTimeout(() => inp.style.background = '', 1000);
                    } catch (error) {
                        console.error('Error updating inventory:', error);
                        alert('Kunne ikke oppdatere inventar');
                        inp.value = inp.getAttribute('data-orig-value');
                    }
                });
                inp.setAttribute('data-orig-value', inp.value);
            });
        } catch (error) {
            console.error('Error loading printable items:', error);
            container.innerHTML += `<div style="background:#fff3cd;padding:15px;border-radius:4px;margin-top:20px;border-left:4px solid #ffc107;">
                <strong style="color:#856404">‚ö†Ô∏è Feil ved lasting av trykkbare varer</strong>
                <pre style="margin:10px 0;font-size:12px;color:#856404;background:#fffbea;padding:10px;border-radius:3px">${error.message}</pre>
                <p style="font-size:12px;color:#666;margin:0">Sjekk at databasemigrasjonen er kj√∏rt.</p>
            </div>`;
        }
    }

    async function addNewPrintable(){
        const name = document.getElementById('newPrintName').value.trim();
        const desc = document.getElementById('newPrintDesc').value.trim();
        const cat = document.getElementById('newPrintCat').value;
        const price = document.getElementById('newPrintPrice').value || 0;
        
        if (!name) { alert('Skriv navn p√• varen'); return; }
        
        try {
            console.log('Adding printable item:', {name, desc, cat, price});
            const response = await fetch('https://reg.kkgit.no/MS/api/printable-items.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name, description: desc, category: cat, price: parseFloat(price)
                })
            });
            
            const result = await response.json();
            console.log('API response:', response.status, result);
            
            if (!response.ok) {
                throw new Error(result.error || 'Server error: ' + response.status);
            }
            
            alert('Vare opprettet!');
            document.getElementById('newPrintName').value = '';
            document.getElementById('newPrintDesc').value = '';
            showHeadTab('hPrintable');
        } catch (error) {
            console.error('Error adding printable:', error);
            alert('Kunne ikke opprette vare:\n' + error.message);
        }
    }

    async function deletePrintable(id){
        if (!confirm('Er du sikker?')) return;
        try {
            await fetch(`https://reg.kkgit.no/MS/api/printable-items.php?id=${id}`, {method: 'DELETE'});
            alert('Vare slettet!');
            showHeadTab('hPrintable');
        } catch (error) {
            alert('Kunne ikke slette vare');
        }
    }

    function showAddVariant(itemId){
        const inputs = prompt('Skriv st√∏rrelse og farge (f.eks. "M,bl√•,50"):\nFormat: st√∏rrelse,farge,antall');
        if (!inputs) return;
        const [size, color, qty] = inputs.split(',').map(s => s.trim());
        if (!size || !color) { alert('Ugyldig format'); return; }
        addPrintableVariant(itemId, size, color, parseInt(qty) || 0);
    }

    async function addPrintableVariant(itemId, size, color, qty){
        try {
            const response = await fetch('https://reg.kkgit.no/MS/api/printable-inventory.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_id: itemId,
                    size, color,
                    quantity: qty
                })
            });
            if (!response.ok) throw new Error('Failed');
            alert('Variant opprettet!');
            showHeadTab('hPrintable');
        } catch (error) {
            alert('Kunne ikke opprette variant');
        }
    }

    async function deletePrintableInv(invId){
        if (!confirm('Slett denne varianten?')) return;
        try {
            await fetch(`https://reg.kkgit.no/MS/api/printable-inventory.php?inv_id=${invId}`, {method: 'DELETE'});
            alert('Variant slettet!');
            showHeadTab('hPrintable');
        } catch (error) {
            alert('Kunne ikke slette variant');
        }
    }

    var editPrintable = () => alert('Edit-funksjon kommer snart'); // Placeholder

    // ===== PROBLEMS TAB =====
    async function renderHeadProblems(){
        const container = document.getElementById('hProblemsTab');
        container.innerHTML = '<h3>‚ö†Ô∏è Problemer fra brukere</h3><p style="color:#666">Oversikt over rapporterte problemer med utstyr.</p>';

        try {
            const response = await fetch('api/reports.php');
            if(!response.ok) throw new Error('Failed to load reports');
            
            const reports = await response.json();
            
            if(reports.length === 0){
                container.innerHTML += '<div style="text-align:center;padding:40px;color:#999"><p style="font-size:16px">üòä Ingen problemer rapportert</p></div>';
                return;
            }

            reports.slice().reverse().forEach(p => {
                const item = document.createElement('div');
                item.className = 'issue-item';
                const statusClass = p.status === 'RESOLVED' ? 'status-resolved' : 'status-open';
                const statusText = p.status === 'RESOLVED' ? '‚úì L√∏st' : '‚ö†Ô∏è √Öpent';
                
                item.innerHTML = `
                    <h5>
                        <span>${p.title}</span>
                        <span class="issue-status ${statusClass}">${statusText}</span>
                    </h5>
                    <div class="issue-description">${p.desc || '(ingen beskrivelse)'}</div>
                    <div class="issue-actions">
                        <button class="resolve-btn btn-primary" data-id="${p.id}" data-status="${p.status}" style="flex:1">${p.status === 'RESOLVED' ? 'Gjen√•pne problem' : 'Marker som l√∏st'}</button>
                    </div>
                `;
                container.appendChild(item);
            });

            container.querySelectorAll('.resolve-btn').forEach(b => b.addEventListener('click', async ()=>{
                const id = Number(b.getAttribute('data-id'));
                const currentStatus = b.getAttribute('data-status');
                const newStatus = currentStatus === 'RESOLVED' ? 'NEW' : 'RESOLVED';
                
                try {
                    const updateResponse = await fetch(`api/reports.php?id=${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });
                    
                    if(!updateResponse.ok) throw new Error('Failed to update');
                    renderHeadProblems();
                } catch (error) {
                    console.error(error);
                    alert('Kunne ikke oppdatere status');
                }
            }));
        } catch (error) {
            console.error(error);
            container.innerHTML += '<div style="background:#ffebee;padding:15px;border-radius:4px;margin-top:20px;border-left:4px solid #e74c3c;"><strong style="color:#c00">‚ùå Feil ved lasting av problemer</strong><p style="font-size:12px;color:#666;margin:5px 0">Det oppstod en feil ved lasting av data fra serveren.</p></div>';
        }
    }

    // ===== TASKS TAB =====
    async function renderHeadTasks(){
        const container = document.getElementById('hTasksTab');
        container.innerHTML = '<h3>‚úÖ Oppgaver fra sekund√¶radmin</h3><p style="color:#666">Oppgaver som skal utf√∏res av superadmin.</p>';

        try {
            const response = await fetch('api/tasks.php');
            if(!response.ok) throw new Error('Failed to load tasks');
            
            const tasks = await response.json();
            
            if(tasks.length === 0){
                container.innerHTML += '<div style="text-align:center;padding:40px;color:#999"><p style="font-size:16px">üéâ Ingen oppgaver</p></div>';
                return;
            }

            tasks.slice().reverse().forEach(t => {
                const item = document.createElement('div');
                item.className = 'issue-item';
                item.style.borderLeft = t.status === 'done' ? '4px solid #27ae60' : '4px solid #3498db';
                const statusClass = t.status === 'done' ? 'status-done' : 'status-open';
                const statusText = t.status === 'done' ? '‚úì Utf√∏rt' : '‚è≥ Venter';
                
                item.innerHTML = `
                    <h5>
                        <span>${t.title}</span>
                        <span class="issue-status ${statusClass}">${statusText}</span>
                    </h5>
                    <div class="issue-description">${t.desc || '(ingen beskrivelse)'}</div>
                    <div class="issue-actions">
                        <button class="resolve-task-btn btn-success" data-id="${t.id}" data-status="${t.status}" style="flex:1">
                            ${t.status === 'done' ? 'Gjen√•pne oppgave' : 'Marker som utf√∏rt'}
                        </button>
                        ${t.status === 'done' ? '<button class="delete-task-btn btn-danger" data-id="' + t.id + '" style="width:auto;">Slett</button>' : ''}
                    </div>
                `;
                container.appendChild(item);
            });

            container.querySelectorAll('.resolve-task-btn').forEach(b => b.addEventListener('click', async ()=>{
                const id = Number(b.getAttribute('data-id'));
                const currentStatus = b.getAttribute('data-status');
                const newStatus = currentStatus === 'done' ? 'open' : 'done';
                
                try {
                    const updateResponse = await fetch(`api/tasks.php?id=${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });
                    
                    if(!updateResponse.ok) throw new Error('Failed to update');
                    renderHeadTasks();
                } catch (error) {
                    console.error(error);
                    alert('Kunne ikke oppdatere oppgave');
                }
            }));

            container.querySelectorAll('.delete-task-btn').forEach(b => b.addEventListener('click', async ()=>{
                const id = Number(b.getAttribute('data-id'));
                if(confirm('Slett denne oppgaven?')){
                    try {
                        const deleteResponse = await fetch(`api/tasks.php?id=${id}`, { method: 'DELETE' });
                        if(!deleteResponse.ok) throw new Error('Failed to delete');
                        renderHeadTasks();
                    } catch (error) {
                        console.error(error);
                        alert('Kunne ikke slette oppgave');
                    }
                }
            }));
        } catch (error) {
            console.error(error);
            container.innerHTML += '<div style="background:#ffebee;padding:15px;border-radius:4px;margin-top:20px;border-left:4px solid #e74c3c;"><strong style="color:#c00">‚ùå Feil ved lasting av oppgaver</strong><p style="font-size:12px;color:#666;margin:5px 0">Det oppstod en feil ved lasting av data fra serveren.</p></div>';
        }
    }

    // ===== MANUALS TAB =====
    function renderHeadManuals(){
        const container = document.getElementById('hManualsTab');
        container.innerHTML = `
            <h3>üìñ Rediger brukermanualer</h3>
            <p style="color:#666">Lag detaljerte brukermanualer med tekst, bilder, lister og overskrifter.</p>
            <div style="background:#e8f4f8;padding:12px;border-radius:4px;margin-bottom:15px;border-left:4px solid #3498db;font-size:13px;color:#555;">
                <strong>üí° Tips:</strong> Du kan dra og slippe bilder direkte i editoren eller kopiere dem fra mappen "Bilder". Bruk knappene i verkt√∏ylinjen for formatering.
            </div>
            <label style="display:block;margin-bottom:10px;font-weight:bold">Velg utstyr:</label>
            <select id="manualProductSelect" style="margin-bottom:15px;display:block;width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px">
                ${PRODUCTS.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('')}
            </select>
            <div class="manual-toolbar">
                <button data-cmd="bold" title="Fet"><b>B</b></button>
                <button data-cmd="italic" title="Kursiv"><i>I</i></button>
                <button data-cmd="underline" title="Understrek"><u>U</u></button>
                <button data-cmd="insertUnorderedList" title="Punktliste">‚Ä¢ Liste</button>
                <button data-cmd="insertOrderedList" title="Nummerert liste">1. Liste</button>
                <button data-cmd="formatBlock" data-val="h2" title="Overskrift">H2</button>
                <button data-cmd="formatBlock" data-val="h3" title="Underoverskrift">H3</button>
                <button data-cmd="formatBlock" data-val="p" title="Avsnitt">P</button>
                <button id="insertImageBtn" title="Sett inn bilde">üñºÔ∏è Bilde</button>
            </div>
            <div id="manualEditor" contenteditable="true" class="manual-editor" style="border:2px solid #ddd"></div>
            <div class="manual-actions">
                <button id="manualSaveBtn">üíæ Lagre manual</button>
                <button id="manualPreviewBtn">üëÅÔ∏è Forh√•ndsvis</button>
                <span id="manualSaveStatus" style="margin-left:15px"></span>
            </div>
        `;

        loadManualContent(PRODUCTS[0].id);

        document.getElementById('manualProductSelect').addEventListener('change', e => {
            loadManualContent(Number(e.target.value));
        });

        container.querySelectorAll('.manual-toolbar button').forEach(btn => {
            if(btn.id === 'insertImageBtn') return;
            btn.addEventListener('click', ()=>{
                const cmd = btn.getAttribute('data-cmd');
                const val = btn.getAttribute('data-val') || null;
                document.execCommand(cmd, false, val);
                document.getElementById('manualEditor').focus();
            });
        });

        document.getElementById('insertImageBtn').addEventListener('click', ()=>{
            const imageUrl = prompt('Lim inn bilde-URL eller velg fra bildegalleriet:\n(Eksempel: https://example.com/image.png)');
            if(imageUrl){
                document.execCommand('insertImage', false, imageUrl);
                document.getElementById('manualEditor').focus();
            }
        });

        document.getElementById('manualSaveBtn').addEventListener('click', ()=>{
            saveManualToDatabase();
        });

        document.getElementById('manualPreviewBtn').addEventListener('click', ()=>{
            const productId = Number(document.getElementById('manualProductSelect').value);
            openManualPreview(productId);
        });
    }

    async function loadManualContent(productId){
        const editor = document.getElementById('manualEditor');
        const product = PRODUCTS.find(p => p.id === productId);
        
        editor.textContent = 'Laster...';
        
        try {
            const response = await fetch(`api/manual.php?id=${productId}`);
            if(!response.ok) throw new Error('Failed to load manual');
            
            const data = await response.json();
            editor.innerHTML = data.content;
        } catch (error) {
            console.error(error);
            editor.innerHTML = '<h2>' + product.name + '</h2><p>Skriv brukermanual her...</p>';
        }
    }

    async function saveManualToDatabase(){
        const productId = Number(document.getElementById('manualProductSelect').value);
        const content = document.getElementById('manualEditor').innerHTML;
        
        if(!content || content === '<br>') {
            alert('Skriv noe innhold f√∏rst.');
            return;
        }
        
        try {
            const response = await fetch(`api/manual.php?id=${productId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ manual_content: content })
            });
            
            if(!response.ok) throw new Error('Failed to save manual');
            
            document.getElementById('manualSaveStatus').textContent = 'Lagret!';
            setTimeout(()=> document.getElementById('manualSaveStatus').textContent = '', 2000);
        } catch (error) {
            console.error(error);
            alert('Kunne ikke lagre manual');
        }
    }

    // ===== MANUAL PREVIEW MODAL =====
    async function openManualPreview(productId){
        const product = PRODUCTS.find(p => p.id === productId);
        
        try {
            const response = await fetch(`api/manual.php?id=${productId}`);
            if(!response.ok) throw new Error('Failed to load manual');
            
            const data = await response.json();
            const content = data.content;

            const modal = document.getElementById('guideModal');
            const iframe = document.getElementById('guideFrame');
            iframe.style.display = 'none';

            let contentDiv = document.getElementById('manualContentDisplay');
            if(!contentDiv){
                contentDiv = document.createElement('div');
                contentDiv.id = 'manualContentDisplay';
                contentDiv.className = 'manual-content-display';
                modal.querySelector('.modal-box').appendChild(contentDiv);
            }
            contentDiv.style.display = 'block';
            contentDiv.innerHTML = '<h2>' + product.name + ' - Brukermanual</h2>' + content;
            modal.style.display = 'flex';
        } catch (error) {
            console.error(error);
            alert('Kunne ikke laste forh√•ndsvisning');
        }
    }

    function closeGuide(){
        document.getElementById('guideModal').style.display = 'none';
        document.getElementById('guideFrame').src = '';
        document.getElementById('guideFrame').style.display = '';
        const contentDiv = document.getElementById('manualContentDisplay');
        if(contentDiv) contentDiv.style.display = 'none';
    }

    // ===== IMAGES TAB =====
    let currentImageFolder = null;

    function renderHeadImages(){
        const container = document.getElementById('hImagesTab');
        const subfolders = state.imageFolders.filter(f => f.parentId === currentImageFolder);
        const folderImages = state.images.filter(img => img.folderId === currentImageFolder);

        container.innerHTML = `
            <h3>üñºÔ∏è Bilder og mapper</h3>
            <p style="color:#666">Organiser bilder i mapper for bruk i manualer og annet innhold.</p>
            <div style="background:#e8f4f8;padding:12px;border-radius:4px;margin-bottom:15px;border-left:4px solid #3498db;font-size:13px;color:#555;display:flex;justify-content:space-between;align-items:center">
                <span style="margin-top:0"><strong>Plassering:</strong> ${buildBreadcrumbs(currentImageFolder)}</span>
                <span class="storage-info" id="storageInfo" style="font-size:11px;color:#999"></span>
            </div>
            <div style="display:flex;gap:10px;margin-bottom:15px">
                <button id="createFolderBtn" class="btn-success" style="flex:1;padding:10px">üìÅ Ny mappe</button>
                <button id="uploadImageBtn" class="btn-primary" style="flex:1;padding:10px">‚¨ÜÔ∏è Last opp bilder</button>
                <input type="file" id="imageFileInput" accept="image/*" multiple style="display:none">
            </div>
            <div class="image-gallery">
                ${subfolders.map(f => `
                    <div class="folder-item-card" data-folder-id="${f.id}">
                        <div class="folder-icon">üìÅ</div>
                        <div class="folder-name">${f.name}</div>
                        <div style="font-size:11px;color:#999;margin-top:8px">
                            <button class="rename-folder-btn" data-id="${f.id}" style="padding:4px 8px;background:#3498db;color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px">Endre navn</button>
                            <button class="delete-folder-btn" data-id="${f.id}" style="padding:4px 8px;background:#e74c3c;color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px">Slett</button>
                        </div>
                    </div>
                `).join('')}
            </div>
            ${folderImages.length === 0 && subfolders.length === 0 ? '<div style="text-align:center;padding:40px;color:#999"><p>üì≠ Tom mappe</p></div>' : ''}
            <div class="image-gallery">
                ${folderImages.map(img => `
                    <div class="image-item-card" data-image-id="${img.id}">
                        <img src="${img.dataUrl}" alt="${img.name}" class="image-item-img">
                        <div class="image-item-name" title="${img.name}">${img.name}</div>
                        <div style="padding:8px;border-top:1px solid #f0f0f0;display:flex;gap:4px;font-size:11px">
                            <button class="move-image-btn" data-id="${img.id}" style="flex:1;padding:5px;background:#3498db;color:white;border:none;border-radius:3px;cursor:pointer">Flytt</button>
                            <button class="delete-image-btn" data-id="${img.id}" style="flex:1;padding:5px;background:#e74c3c;color:white;border:none;border-radius:3px;cursor:pointer">Slett</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        updateStorageInfo();

        document.getElementById('createFolderBtn').addEventListener('click', ()=>{
            const name = prompt('Mappenavn:');
            if(!name) return;
            state.imageFolders.push({ id: Date.now(), name: name, parentId: currentImageFolder });
            saveState();
            renderHeadImages();
        });

        document.getElementById('uploadImageBtn').addEventListener('click', ()=>{
            document.getElementById('imageFileInput').click();
        });
        document.getElementById('imageFileInput').addEventListener('change', (e)=>{
            handleImageUpload(e.target.files);
        });

        container.querySelectorAll('.folder-item-card').forEach(el => {
            el.addEventListener('click', (e)=>{
                if(e.target.closest('button')) return;
                const folderId = Number(el.getAttribute('data-folder-id'));
                currentImageFolder = folderId;
                renderHeadImages();
            });
        });

        container.querySelectorAll('.breadcrumb-link').forEach(a => {
            a.addEventListener('click', (e)=>{
                e.preventDefault();
                const val = a.getAttribute('data-folder-id');
                currentImageFolder = val === 'null' ? null : Number(val);
                renderHeadImages();
            });
        });

        container.querySelectorAll('.rename-folder-btn').forEach(b => b.addEventListener('click', (e)=>{
            e.stopPropagation();
            const id = Number(b.getAttribute('data-id'));
            const folder = state.imageFolders.find(f => f.id === id);
            if(!folder) return;
            const newName = prompt('Nytt navn:', folder.name);
            if(newName && newName !== folder.name){
                folder.name = newName;
                saveState();
                renderHeadImages();
            }
        }));

        container.querySelectorAll('.delete-folder-btn').forEach(b => b.addEventListener('click', (e)=>{
            e.stopPropagation();
            const id = Number(b.getAttribute('data-id'));
            if(!confirm('Slett denne mappen og alt innholdet?')) return;
            deleteFolderRecursive(id);
            saveState();
            renderHeadImages();
        }));

        container.querySelectorAll('.move-image-btn').forEach(b => b.addEventListener('click', ()=>{
            const id = Number(b.getAttribute('data-id'));
            moveImage(id);
        }));

        container.querySelectorAll('.delete-image-btn').forEach(b => b.addEventListener('click', ()=>{
            const id = Number(b.getAttribute('data-id'));
            if(!confirm('Slett dette bildet?')) return;
            state.images = state.images.filter(i => i.id !== id);
            saveState();
            renderHeadImages();
        }));
    }

    function buildBreadcrumbs(folderId){
        const parts = [{ id: null, name: 'Rot' }];
        let current = folderId;
        while(current !== null){
            const folder = state.imageFolders.find(f => f.id === current);
            if(!folder) break;
            parts.push({ id: folder.id, name: folder.name });
            current = folder.parentId;
        }
        if(parts.length > 1){
            const root = parts[0];
            const rest = parts.slice(1).reverse();
            parts.length = 0;
            parts.push(root, ...rest);
        }
        return parts.map((p, i) => {
            if(i === parts.length - 1) return '<span>' + p.name + '</span>';
            return '<a href="#" class="breadcrumb-link" data-folder-id="' + (p.id === null ? 'null' : p.id) + '">' + p.name + '</a>';
        }).join(' / ');
    }

    function handleImageUpload(files){
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e){
                state.images.push({
                    id: Date.now() + Math.floor(Math.random() * 1000),
                    name: file.name,
                    folderId: currentImageFolder,
                    dataUrl: e.target.result,
                    createdAt: new Date().toISOString()
                });
                saveState();
                renderHeadImages();
            };
            reader.readAsDataURL(file);
        });
    }

    function moveImage(imageId){
        const allFolders = [{ id: null, name: 'Rot (toppniv√•)' }, ...state.imageFolders];
        const folderNames = allFolders.map((f, i) => i + ': ' + f.name).join('\n');
        const choice = prompt('Velg mappe (skriv nummer):\n' + folderNames);
        if(choice === null) return;
        const idx = parseInt(choice);
        if(isNaN(idx) || idx < 0 || idx >= allFolders.length){ alert('Ugyldig valg'); return; }

        const img = state.images.find(i => i.id === imageId);
        if(img){
            img.folderId = allFolders[idx].id;
            saveState();
            renderHeadImages();
        }
    }

    function deleteFolderRecursive(folderId){
        state.images = state.images.filter(i => i.folderId !== folderId);
        const children = state.imageFolders.filter(f => f.parentId === folderId);
        children.forEach(child => deleteFolderRecursive(child.id));
        state.imageFolders = state.imageFolders.filter(f => f.id !== folderId);
    }

    function updateStorageInfo(){
        const el = document.getElementById('storageInfo');
        if(!el) return;
        try {
            const used = new Blob([JSON.stringify(state)]).size;
            const usedKB = (used / 1024).toFixed(1);
            el.textContent = 'Lagring: ' + usedKB + ' KB brukt';
            if(used > 4 * 1024 * 1024) el.style.color = 'red';
        } catch(e){ /* ignore */ }
    }

    // ===== ADMIN ACCOUNTS TAB =====
    async function renderHeadAdmins(){
        const container = document.getElementById('hAdminsTab');
        container.innerHTML = '<h3>üë• Administratorer</h3><p style="color:#666">Laster administratorer‚Ä¶</p>';

        try {
            const resp = await fetch('api/admins.php');
            if(!resp.ok) throw new Error('Kunne ikke hente administratorer');
            const accounts = await resp.json();

            let rows = '';
            accounts.forEach(a => {
                const isDefault = (a.id === 1);
                const statusIcon = a.isActive ? 'üü¢ Aktiv' : 'üî¥ Deaktivert';
                const roleIcon = a.role === 'HEAD_ADMIN' ? 'üëë Superadmin' : 'üìã Sekund√¶radmin';
                rows += `<tr>
                    <td>${a.username}</td>
                    <td>${a.fullName}</td>
                    <td>${roleIcon}</td>
                    <td>${statusIcon}</td>
                    <td>${isDefault ? '<span style="color:#999;font-size:11px">Standard</span>' : '<button class="delete-admin-btn btn-danger" data-id="' + a.id + '" style="padding:6px 10px;font-size:11px">Slett</button>'}</td>
                </tr>`;
            });

            container.innerHTML = `
                <h3>üë• Administratorer</h3>
                <p style="color:#666">Administrer brukere som har admin-tilgang til systemet.</p>
                <table class="admin-table">
                    <thead><tr><th>Brukernavn</th><th>Navn</th><th>Rolle</th><th>Status</th><th>Handling</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <hr style="margin:30px 0;border:none;border-top:2px solid #eee">
                <h4 style="margin-top:0">‚ûï Legg til ny sekund√¶radmin</h4>
                <div class="admin-form">
                    <input type="text" id="newAdminUsername" placeholder="E-post (brukernavn) *" style="margin-bottom:10px">
                    <input type="text" id="newAdminFullName" placeholder="Fullt navn *" style="margin-bottom:10px">
                    <input type="password" id="newAdminPassword" placeholder="Passord *" style="margin-bottom:10px">
                    <button id="addAdminBtn">Opprett administrator</button>
                </div>
            `;

            // Delete admin (server-side)
            container.querySelectorAll('.delete-admin-btn').forEach(b => b.addEventListener('click', async ()=>{
                const id = Number(b.getAttribute('data-id'));
                if(!confirm('Slett denne administratoren? Denne operasjonen kan ikke angres.')) return;
                try {
                    const del = await fetch(`api/admins.php?id=${id}`, { method: 'DELETE' });
                    if(!del.ok) throw new Error('Delete failed');
                    alert('Administrator slettet');
                    renderHeadAdmins();
                } catch (err) {
                    console.error(err);
                    alert('Kunne ikke slette administrator');
                }
            }));

            // Add admin (server-side)
            document.getElementById('addAdminBtn').addEventListener('click', async ()=>{
                const username = document.getElementById('newAdminUsername').value.trim();
                const fullName = document.getElementById('newAdminFullName').value.trim();
                const password = document.getElementById('newAdminPassword').value;

                if(!username || !fullName || !password){
                    alert('Fyll inn alle obligatoriske feltene.');
                    return;
                }

                try {
                    const post = await fetch('api/admins.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, fullName, password, role: 'INVENTORY_ADMIN' })
                    });
                    const r = await post.json();
                    if(!post.ok) {
                        throw new Error(r.error || 'Kunne ikke opprette');
                    }
                    alert('Administrator opprettet! üéâ');
                    document.getElementById('newAdminUsername').value = '';
                    document.getElementById('newAdminFullName').value = '';
                    document.getElementById('newAdminPassword').value = '';
                    renderHeadAdmins();
                } catch (err) {
                    console.error(err);
                    alert('Kunne ikke opprette administrator: ' + (err.message || ''));
                }
            });

        } catch (error) {
            console.error('Error loading admins:', error);
            container.innerHTML = '<p style="color:#c00">Kunne ikke hente administratorer fra serveren.</p>';
        }
    }

    // ===== MODAL CLOSE =====
    document.getElementById('closeGuideBtn').addEventListener('click', closeGuide);
    window.addEventListener('click', function(e){
        if(e.target.classList.contains('modal')) e.target.style.display = 'none';
    });

    // ===== INIT =====
    (async () => {
        await loadProducts();
        loadState();
        document.querySelectorAll('.htab-btn').forEach(b => b.addEventListener('click', ()=> showHeadTab(b.getAttribute('data-tab'))));
        renderHeadAdmin('hProducts');
    })();
    </script>
</body>
</html>
